@{
    ViewData["Title"] = "Dashboard - Criança";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
  <div class="col-md-4">
    <div class="card p-3">
      <img src="https://placehold.co/128x128" alt="avatar" 
           style="width:64px;height:64px;border-radius:50%"/>
      <h4 id="childName">Nome da Criança</h4>
      <p id="childAge">Idade: --</p>
      <h6>Conquistas</h6>
      <ul id="conquistas"></ul>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card p-3">
      <h4>Dashboard</h4>
      <p>Progresso geral: <strong id="progressoGeral">--%</strong></p>

      <label>Filtrar atividades:
        <select class="form-select w-auto" id="filtroFaixa">
          <option value="">Todas</option>
          <option>7-8</option>
          <option>9-10</option>
          <option>11-12</option>
        </select>
      </label>

      <h5 class="mt-3">Atividades</h5>
      <div id="ativs"></div>
    </div>
  </div>
</div>

@section Scripts {
<script>
const faixaSelect = document.getElementById('filtroFaixa');
const ativDiv = document.getElementById('ativs');
const progressoGeral = document.getElementById('progressoGeral');

// Mock temporário para criança e conquistas
document.getElementById('childName').innerText = "Ana Silva";
document.getElementById('childAge').innerText = "Idade: 9 anos";
document.getElementById('conquistas').innerHTML = "<li>Primeiro quiz</li><li>50% Matemática</li>";

async function carregarAtividades(faixa = ''){
  const url = faixa 
    ? `/api/atividade/porCategoria?faixa=${faixa}` 
    : '/api/atividade';
  const resp = await fetch(url);
  const dados = await resp.json();

  if (!Array.isArray(dados)) return;

  // Calcular progresso geral fictício
  const concluidas = dados.filter(a => a.status === 'concluido').length;
  const total = dados.length || 1;
  progressoGeral.textContent = Math.round((concluidas/total)*100) + '%';

  ativDiv.innerHTML = dados.map(a=>`
    <div class="mb-2">
      <strong>${a.titulo}</strong> — ${a.descricao ?? 'Disponível'} —
      <a href="/AtividadeMvc/Detalhe/${a.id_atividade}" class="btn btn-sm btn-primary">
        Iniciar
      </a>
    </div>`).join('');
}

faixaSelect.addEventListener('change', e => {
  carregarAtividades(e.target.value);
});

// Carrega todas ao abrir
carregarAtividades();

async function carregarAtividades(faixa) {
  const res = await fetch(`/api/Atividade/dashboard?faixa=${faixa || ''}`);
  const atividades = await res.json();

  const container = document.getElementById('ativs');
  container.innerHTML = '';

  atividades.forEach(a => {
    const div = document.createElement('div');
    div.className = 'mb-2';
    div.innerHTML = `<strong>${a.titulo}</strong> — ${a.categoria} — 
      <a href="/AtividadeMvc/Detalhe/${a.id}" class="btn btn-sm btn-primary">Iniciar</a>`;
    container.appendChild(div);
  });
}

document.getElementById('filtroFaixa').addEventListener('change', e => {
  carregarAtividades(e.target.value);
});

// Carregar inicialmente
carregarAtividades();

</script>
}
